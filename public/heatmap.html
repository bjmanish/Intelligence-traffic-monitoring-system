<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Dynamic Heatmap with Markers</title>
  <style>
    #map {
      height: 100%;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #floating-panel {
      position: absolute;
      top: 10px;
      left: 25%;
      z-index: 5;
      background-color: #fff;
      padding: 5px;
      border: 1px solid #999;
      text-align: center;
      font-family: 'Roboto', 'sans-serif';
      line-height: 30px;
      padding-left: 10px;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    let map, heatmap;
    let infowindow;
    let markers = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14,
        center: { lat: 23.2622, lng: 77.4126 } // Ayodhya Bypass, Bhopal
      });

      infowindow = new google.maps.InfoWindow();

      heatmap = new google.maps.visualization.HeatmapLayer({
        data: [],
        map: map
      });

      const trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      // Load accident data every 2 seconds
      setInterval(fetchAndUpdateData, 2000);
    }



    function fetchAndUpdateData() {
      fetch('http://localhost:3000/accidentInfo')
        .then(res => res.json())
        .then(res => {
          // Clear old markers
          markers.forEach(marker => marker.setMap(null));
          markers = [];

          // Update heatmap data
          const heatmapData = res.map(i => new google.maps.LatLng(
            parseFloat(i.location.latitude),
            parseFloat(i.location.longitude)
          ));
          heatmap.setData(heatmapData);

          // Add new markers
          res.forEach(i => {
            let img = `<img src='${i.imageLink}' width="300px" height="auto"/>`;
            const latLng = {
              lat: parseFloat(i.location.latitude),
              lng: parseFloat(i.location.longitude)
            };
            const marker = new google.maps.Marker({
              position: latLng,
              map: map,
              title: 'Accident'
            });
            marker.addListener('click', () => {
              infowindow.close();
              infowindow.setContent(img);
              infowindow.open(map, marker);
            });
            markers.push(marker);
          });
        })
        .catch(err => console.error("Error fetching accident data:", err));
    }
  </script>

    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA99skK-9Nbs0XIn340PKxdPbtN4xL30G0&loading=async&libraries=visualization&callback=initMap">
    </script>
  </body>

</html>

<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bhopal Map Simulation</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v0.35.0/mapbox-gl.css">
    <script src="js/main.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v0.35.0/mapbox-gl.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwoSD3UICvG_YxjQ80U4eenRPS9dvhpJU"></script>
    <style>
        .marker-custom {
            background-image: url('red.jpg');
            background-repeat: no-repeat;
            background-size: contain;
            position: absolute;
            z-index: 1;
            display: block;
            border-radius: 0%;
            height: 85px;
            width: 30px;
        }

        .marker-green {
            background-image: url('green.jpg');
            background-repeat: no-repeat;
            background-size: contain;
            position: absolute;
            z-index: 1;
            display: block;
            border-radius: 0%;
            height: 85px;
            width: 30px;
        }

        #map {
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>
    <div class="user-options-box">
        <div class="user-options-box-title"></div>
        <div class="user-options-box-set-button" onclick="originSelect(); removeMostRecentRoute(); removeMostRecentPoint();">Set Origin</div>
        <div class="user-options-box-set-button" onclick="destinationSelect(); removeMostRecentRoute(); removeMostRecentPoint();">Set Destination</div>
        <div class="user-options-box-button" onclick="calcRoute(); removeMostRecentPoint();">Go!</div>
        <div class="user-options-box-simulate" id="simulate-container">
            <p>Set an average speed:</p>
            <form action="javascript:simulateRoute();">
                <input type="number" name="simulationSpeed" placeholder="Km/h" />
                <input type="submit" style="position: absolute; left: -9999px"/>
            </form>
            <div class="user-options-box-button" onclick="simulateRoute();">Simulate!</div>
        </div>
    </div>

    <div class="mapbox-container">
        <div id="map"></div>
    </div>

    <script>
        // Set up Mapbox map centered on Ayodhya Bypass, Bhopal
        mapboxgl.accessToken = "pk.eyJ1IjoiYWxlY2tyZXRjaCIsImEiOiJjajFmNGNkcTkwMGEwMndwM2FjNHY2cHJkIn0.t0Qakhusiu9vM3RADzORxA";
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            center: [77.4126, 23.2622], // Bhopal Ayodhya Bypass
            zoom: 14
        });

        map.addControl(new mapboxgl.NavigationControl());
        map.on('click', function(e) {
            placeMarker(e);
        });

        var geojson = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "message": "Traffic Light 1",
                        "iconSize": [60, 60]
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [77.4087, 23.2620]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "message": "Traffic Light 2",
                        "iconSize": [50, 50]
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [77.4160, 23.2635]
                    }
                }
            ]
        };

        function distance(lat1, lon1, lat2, lon2, unit) {
            var radlat1 = Math.PI * lat1 / 180;
            var radlat2 = Math.PI * lat2 / 180;
            var theta = lon1 - lon2;
            var radtheta = Math.PI * theta / 180;
            var dist = Math.sin(radlat1) * Math.sin(radlat2) +
                       Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
            dist = Math.acos(dist);
            dist = dist * 180 / Math.PI;
            dist = dist * 60 * 1.1515;
            if (unit == "K") { dist = dist * 1.609344 }
            if (unit == "N") { dist = dist * 0.8684 }
            return dist;
        }

        // Dummy vehicle coordinates generator (simulate movement near Ayodhya Bypass)
        function getCoord() {
            let baseLat = 23.2625;
            let baseLng = 77.4125;
            let jitter = () => (Math.random() - 0.5) * 0.002;
            return [baseLng + jitter(), baseLat + jitter()];
        }

        // Markers
        var el = document.createElement('div');
        el.className = 'marker-custom';

        var ell = document.createElement('div');
        ell.className = 'marker-green';

        el.addEventListener('click', function() {
            alert("Traffic Light 1");
        });

        ell.addEventListener('click', function() {
            alert("Traffic Light 2");
        });

        // Simulate color change based on proximity
        setInterval(function () {
            var coords = getCoord();
            var longMov = coords[0];
            var latMov = coords[1];
            var light1 = geojson.features[0].geometry.coordinates;
            var light2 = geojson.features[1].geometry.coordinates;

            if (distance(latMov, longMov, light1[1], light1[0]) < 0.3) {
                el.style.backgroundImage = 'url(green.jpg)';
            } else {
                el.style.backgroundImage = 'url(red.jpg)';
            }

            if (distance(latMov, longMov, light2[1], light2[0]) < 0.3) {
                ell.style.backgroundImage = 'url(green.jpg)';
            } else {
                ell.style.backgroundImage = 'url(red.jpg)';
            }
        }, 1000);

        // Add markers to map
        for (let i = 0; i < geojson.features.length; i++) {
            if (i == 0) {
                new mapboxgl.Marker(el)
                    .setLngLat(geojson.features[i].geometry.coordinates)
                    .addTo(map);
            } else {
                new mapboxgl.Marker(ell)
                    .setLngLat(geojson.features[i].geometry.coordinates)
                    .addTo(map);
            }
        }
    </script>
</body>
</html>
